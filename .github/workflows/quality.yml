name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python quality tools
      run: |
        pip install black isort flake8 mypy bandit safety
    
    - name: Check code formatting with Black
      run: |
        cd backend
        black --check app
    
    - name: Check import sorting with isort
      run: |
        cd backend
        isort --check-only app
    
    - name: Lint with flake8
      run: |
        cd backend
        flake8 app --max-line-length=88 --extend-ignore=E203,W503
    
    - name: Type check with mypy
      run: |
        cd backend
        mypy app --ignore-missing-imports
    
    - name: Security check with bandit
      run: |
        cd backend
        bandit -r app -ll
    
    - name: Dependency security check
      run: |
        cd backend
        safety check
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Check frontend code formatting
      run: |
        cd frontend
        npm run format:check
    
    - name: Lint frontend code
      run: |
        cd frontend
        npm run lint
    
    - name: Frontend type check
      run: |
        cd frontend
        npm run type-check
    
    - name: Run SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.organization=your-org
          -Dsonar.projectKey=ai-powered-code-review
          -Dsonar.sources=backend/app,frontend/src
          -Dsonar.tests=backend/tests,frontend/src/**/*.test.ts
          -Dsonar.python.coverage.reportPaths=backend/coverage.xml
          -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info